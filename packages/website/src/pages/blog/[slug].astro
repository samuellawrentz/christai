---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Footer from '../../components/sections/Footer.astro';
import BreadcrumbNav from '../../components/BreadcrumbNav.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

import prayerPeopleImg from '../../assets/blog/prayer_people.png';
import prayerPeople1Img from '../../assets/blog/prayer_people_1.png';
import mosesTechImg from '../../assets/blog/moses_tech.png';
import joshuaPrayerImg from '../../assets/blog/joshua_prayer.png';
import blog1Img from '../../assets/blog/blog_1.png';
import blog2Img from '../../assets/blog/blog_2.png';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  const imageMap: Record<string, ImageMetadata> = {
    'prayer_people.png': prayerPeopleImg,
    'prayer_people_1.png': prayerPeople1Img,
    'moses_tech.png': mosesTechImg,
    'joshua_prayer.png': joshuaPrayerImg,
    'blog_1.png': blog1Img,
    'blog_2.png': blog2Img,
  };

  return posts.map((post) => {
    const imageName = post.data.image?.split('/').pop();
    const featuredImage = imageName ? imageMap[imageName] : null;
    return {
      params: { slug: post.slug },
      props: { post, featuredImage },
    };
  });
}

const { post, featuredImage } = Astro.props;
const { Content } = await post.render();

// Get related posts (excluding current post)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .slice(0, 3);
---

<BaseLayout 
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  url={`/blog/${post.slug}/`}
>
  <main class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <!-- Hero Section -->
    <div class="bg-white border-b border-slate-100">
      <div class="container mx-auto px-4 py-16 pt-12">
        <div class="mb-8">
        <!-- Breadcrumb -->
        <BreadcrumbNav items={[
          { label: 'Blog', href: '/blog/' },
          { label: post.data.title }
        ]} />
        </div>

        <!-- Article Header -->
        <header class="max-w-4xl mx-auto text-center">
          <h1 class="text-3xl md:text-5xl font-serif text-slate-900 mb-6">
            {post.data.title}
          </h1>
          
          <p class="text-lg text-slate-600 mb-8 max-w-3xl mx-auto">
            {post.data.description}
          </p>

          <!-- Meta Information -->
          <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-slate-500 mb-8">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <time datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </time>
            </div>
            
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              <span>{post.data.author}</span>
            </div>
          </div>

          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 justify-center">
              {post.data.tags.map((tag) => (
                <span class="px-3 py-1 bg-blue-50 text-blue-600 text-sm rounded-full">
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </header>
      </div>
    </div>

    <!-- Featured Image -->
    {featuredImage && (
      <div class="container mx-auto px-4 -mt-8">
        <div class="max-w-4xl mx-auto">
          <Image 
            src={featuredImage} 
            alt={post.data.title}
            class="w-full rounded-xl shadow-lg object-cover"
            style="max-height: 400px; width: 100%; object-fit: cover;"
          />
        </div>
      </div>
    )}

    <!-- Article Content -->
    <div class="container mx-auto px-4 py-16">
      <article class="max-w-3xl mx-auto">
        <div class="prose prose-lg prose-slate prose-headings:font-serif prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline">
          <Content />
        </div>

        <!-- Article Actions -->
        <div class="mt-16 pt-8 border-t border-slate-200">
          <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <a 
              href="/blog/"
              class="inline-flex items-center text-slate-600 hover:text-slate-900 transition-colors duration-200"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Back to Blog
            </a>

            <div class="flex gap-4">
              <button class="text-slate-600 hover:text-slate-900 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </article>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="bg-white border-t border-slate-100">
        <div class="container mx-auto px-4 py-16">
          <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl md:text-3xl font-serif text-slate-900 mb-8 text-center">
              Related Articles
            </h2>
            
            <div class="grid md:grid-cols-3 gap-6">
              {relatedPosts.map((relatedPost) => (
                <article class="bg-slate-50 rounded-lg p-6 hover:bg-slate-100 transition-colors duration-200">
                  <h3 class="text-lg font-serif text-slate-900 mb-2 line-clamp-2">
                    <a 
                      href={`/blog/${relatedPost.slug}/`}
                      class="hover:text-blue-600 transition-colors duration-200"
                    >
                      {relatedPost.data.title}
                    </a>
                  </h3>
                  
                  <p class="text-slate-600 text-sm mb-4 line-clamp-2">
                    {relatedPost.data.description}
                  </p>
                  
                  <div class="text-xs text-slate-500">
                    {relatedPost.data.pubDate.toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric', 
                      year: 'numeric' 
                    })}
                  </div>
                </article>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}
  </main>
  <Footer />
</BaseLayout>

<style>
  .prose {
    line-height: 1.7;
  }
  
  .prose h2 {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .prose h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }
  
  .prose p {
    margin-bottom: 1.25rem;
  }
  
  .prose blockquote {
    border-left: 4px solid #3b82f6;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #64748b;
  }
  
  .prose ul, .prose ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
